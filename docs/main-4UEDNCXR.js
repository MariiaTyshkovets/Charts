import{a as A}from"./chunk-5HBEZIYN.js";import{a as I}from"./chunk-4II3TBQX.js";import{O as k,P as d,S as l,T as h,V as g,W as T,Z as v,c as a,i as c,j as m,k as u,l as f,s}from"./chunk-32HZZRH4.js";var n={username:"r_test@fintatech.com",password:"kisfiz-vUnvy9-sopnyv",client_id:"app-cli",grant_type:"password"};var p=class o{constructor(e){this.apiService=e;this.loadTokensFromStorage(),d(()=>{this.tokenExpiration()&&this.scheduleTokenRefresh()})}accessToken=s(null);refreshToken=s(null);tokenExpiration=s(null);scope=s(null);refreshTimeoutId=null;get token(){return this.accessToken()}checkAuthentication(){if(!this.token)return!1;let t=this.tokenExpiration();return!t||Date.now()>t?(this.logout(),!1):!0}initializeAuthentication(){return this.checkAuthentication()?new a:this.getAuthToken()}getAuthToken(){let e=new l({"Content-Type":"application/x-www-form-urlencoded"}),t=new h().set("grant_type",n.grant_type).set("client_id",n.client_id).set("username",n.username).set("password",n.password);return this.apiService.post("/identity/realms/fintatech/protocol/openid-connect/token",t.toString(),e).pipe(c(r=>this.storeTokens(r)))}refreshAuthToken(){let e=this.refreshToken();if(e){let t=new l({"Content-Type":"application/x-www-form-urlencoded",Accept:"*/*","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive",Authorization:`Bearer ${this.token}`}),r=new h().set("grant_type",n.grant_type).set("refresh_token",e).set("scope",this.scope()||"").set("client_id",n.client_id);return this.apiService.post("/identity/realms/fintatech/protocol/openid-connect/token",r.toString(),t).pipe(c(i=>this.storeTokens(i)))}else throw new Error("No refresh token available")}storeTokens(e){let t=Date.now();this.accessToken.set(e.access_token),this.refreshToken.set(e.refresh_token),this.scope.set(e.scope),this.tokenExpiration.set(t+e.expires_in*1e3),localStorage.setItem("token",e.access_token),localStorage.setItem("refreshToken",e.refresh_token),localStorage.setItem("tokenExpiration",(t+e.expires_in*1e3).toString()),localStorage.setItem("scope",e.scope)}loadTokensFromStorage(){this.accessToken.set(localStorage.getItem("token")),this.refreshToken.set(localStorage.getItem("refreshToken"));let e=localStorage.getItem("tokenExpiration");this.tokenExpiration.set(e?+e:null),this.scope.set(localStorage.getItem("scope"))}logout(){this.accessToken.set(null),this.refreshToken.set(null),this.tokenExpiration.set(null),this.scope.set(null),localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),localStorage.removeItem("scope"),localStorage.removeItem("tokenExpiration"),this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}scheduleTokenRefresh(){this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId);let e=this.tokenExpiration();if(!e)return;let t=Date.now(),i=e-t-5*60*1e3;i>0&&(this.refreshTimeoutId=setTimeout(()=>{this.refreshAuthToken().subscribe()},i))}static \u0275fac=function(t){return new(t||o)(u(I))};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};var x=(o,e)=>{let t=f(p);return new a(r=>{t.getAuthToken().subscribe({next:i=>{i?r.next(!0):r.next(!1),r.complete()},error:i=>{console.error("Authentication failed",i),r.next(!1),r.complete()}})})};var b=[{path:"",loadComponent:()=>import("./chunk-XFGVCT3P.js").then(o=>o.AppComponent),children:[{path:"",loadComponent:()=>import("./chunk-IWOPOA24.js").then(o=>o.MainComponent),resolve:{isAuthenticated:x}}]}];var S={providers:[k({eventCoalescing:!0}),v(b),g()]};T(A,S).catch(o=>console.error(o));
